{"version":3,"sources":["../src/index.ts","../src/reexports.ts","../src/instance.ts","../src/adapter.ts"],"sourcesContent":["export type { LylaAdapterMeta } from './adapter'\r\nexport type {\r\n  Lyla,\r\n  LylaError,\r\n  LylaProgress,\r\n  LylaRequestOptions,\r\n  LylaResponse,\r\n  LylaResponseError,\r\n  LylaNonResponseError\r\n} from './reexports'\r\nexport { LYLA_ERROR, LylaAbortController } from './reexports'\r\nexport { lyla, isLylaError, createLyla } from './instance'\r\n","import type {\r\n  LylaRequestOptions as LylaCoreRequestOptions,\r\n  LylaResponse as LylaCoreResponse,\r\n  Lyla as LylaCore,\r\n  LylaRequestOptionsWithContext as LylaCoreRequestOptionsWithContext,\r\n  LylaProgress as LylaCoreProgress\r\n} from '@lylajs/core'\r\nimport type {\r\n  LylaResponseError as LylaCoreResponseError,\r\n  LylaError as LylaCoreError,\r\n  LylaNonResponseError as LylaCoreNonResponseError\r\n} from '@lylajs/core'\r\nimport type { LylaAdapterMeta } from './adapter'\r\n\r\n// core\r\nexport type Lyla<C = undefined> = LylaCore<C, LylaAdapterMeta>\r\nexport type LylaRequestOptions<C = undefined> = LylaCoreRequestOptions<\r\n  C,\r\n  LylaAdapterMeta\r\n>\r\nexport type LylaRequestOptionsWithContext<C = undefined> =\r\n  LylaCoreRequestOptionsWithContext<C, LylaAdapterMeta>\r\nexport type LylaResponse<T = any, C = undefined> = LylaCoreResponse<\r\n  T,\r\n  C,\r\n  LylaAdapterMeta\r\n>\r\n\r\n// error\r\nexport type LylaResponseError<C = undefined> = LylaCoreResponseError<\r\n  C,\r\n  LylaAdapterMeta\r\n>\r\nexport type LylaNonResponseError<C = undefined> = LylaCoreNonResponseError<\r\n  C,\r\n  LylaAdapterMeta\r\n>\r\nexport type LylaError<C = undefined> = LylaCoreError<C, LylaAdapterMeta>\r\n\r\nexport type LylaProgress = LylaCoreProgress<LylaAdapterMeta>\r\n\r\nexport { LYLA_ERROR, LylaAbortController } from '@lylajs/core'\r\n","import { createLyla as coreCreateLyla } from '@lylajs/core'\r\nimport { adapter } from './adapter'\r\nimport type {\r\n  LylaRequestOptions,\r\n  LylaRequestOptionsWithContext\r\n} from './reexports'\r\n\r\nexport const { lyla, isLylaError } = coreCreateLyla(adapter, {\r\n  context: undefined\r\n})\r\n\r\nexport const createLyla = <C>(\r\n  options: LylaRequestOptionsWithContext<C>,\r\n  ...overrides: LylaRequestOptions<C>[]\r\n) => {\r\n  return coreCreateLyla(adapter, options, ...overrides)\r\n}\r\n","import type {\r\n  LylaAdapter,\r\n  LylaAdapterMeta as LylaCoreAdapterMeta\r\n} from '@lylajs/core'\r\nimport { headersKeyToLowerCase } from '@lylajs/core'\r\nimport type {\r\n  NetworkErrorDetail,\r\n  ResponseDetail,\r\n  UniRequest,\r\n  UniRequestMethod\r\n} from './types'\r\n\r\ndeclare const uni: {\r\n  request: UniRequest\r\n}\r\n\r\nexport interface LylaAdapterMeta extends LylaCoreAdapterMeta {\r\n  method: UniRequestMethod\r\n  networkErrorDetail: NetworkErrorDetail\r\n  responseDetail: ResponseDetail\r\n  responseType: 'arraybuffer' | 'text'\r\n  requestBody: string | ArrayBuffer | Record<string, unknown>\r\n  progressDetail: never\r\n  originalRequest: never\r\n}\r\n\r\nexport const adapter: LylaAdapter<LylaAdapterMeta> = ({\r\n  url,\r\n  method,\r\n  headers,\r\n  body,\r\n  responseType,\r\n  onResponse,\r\n  onNetworkError\r\n  // Not used, just leave it here\r\n  // json,\r\n  // withCredentials,\r\n  // onDownloadProgress,\r\n  // onUploadProgress,\r\n}): {\r\n  abort: () => void\r\n} => {\r\n\r\n  const requestTask = uni.request({\r\n    url,\r\n    method,\r\n    header: headers,\r\n    //@ts-ignore\r\n    data: isJSON(body) ? JSON.parse(body) : body,\r\n    responseType,\r\n    // https://developers.weixin.qq.com/miniprogram/dev/api/network/request/wx.request.html\r\n    // Docs said if it's not json, response data won't be transformed to json.\r\n    dataType: 'json',\r\n    fail(res) {\r\n      onNetworkError(res)\r\n    },\r\n    success(res) {\r\n      onResponse(\r\n        {\r\n          body: res.data as string | ArrayBuffer,\r\n          status: res.statusCode,\r\n          headers: headersKeyToLowerCase(res.header)\r\n        },\r\n        res\r\n      )\r\n    }\r\n  })\r\n  return {\r\n    abort() {\r\n      requestTask.abort()\r\n    }\r\n  }\r\n}\r\n\r\n\r\nfunction isJSON(str: any) {\r\n  if (typeof str === 'string' && str) {\r\n    if (Object.prototype.toString.call(JSON.parse(str)) === '[object Object]') {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n  return false\r\n}\r\n"],"mappings":";;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;;ACyCA,kBAAgD;;;ACzChD,IAAAA,eAA6C;;;ACI7C,IAAAC,eAAsC;AAsB/B,IAAM,UAAwC,CAAC;AAAA,EACpD;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAMF,MAEK;AAEH,QAAM,cAAc,IAAI,QAAQ;AAAA,IAC9B;AAAA,IACA;AAAA,IACA,QAAQ;AAAA;AAAA,IAER,MAAM,OAAO,IAAI,IAAI,KAAK,MAAM,IAAI,IAAI;AAAA,IACxC;AAAA;AAAA;AAAA,IAGA,UAAU;AAAA,IACV,KAAK,KAAK;AACR,qBAAe,GAAG;AAAA,IACpB;AAAA,IACA,QAAQ,KAAK;AACX;AAAA,QACE;AAAA,UACE,MAAM,IAAI;AAAA,UACV,QAAQ,IAAI;AAAA,UACZ,aAAS,oCAAsB,IAAI,MAAM;AAAA,QAC3C;AAAA,QACA;AAAA,MACF;AAAA,IACF;AAAA,EACF,CAAC;AACD,SAAO;AAAA,IACL,QAAQ;AACN,kBAAY,MAAM;AAAA,IACpB;AAAA,EACF;AACF;AAGA,SAAS,OAAO,KAAU;AACxB,MAAI,OAAO,QAAQ,YAAY,KAAK;AAClC,QAAI,OAAO,UAAU,SAAS,KAAK,KAAK,MAAM,GAAG,CAAC,MAAM,mBAAmB;AACzE,aAAO;AAAA,IACT;AACA,WAAO;AAAA,EACT;AACA,SAAO;AACT;;;AD5EO,IAAM,EAAE,MAAM,YAAY,QAAI,aAAAC,YAAe,SAAS;AAAA,EAC3D,SAAS;AACX,CAAC;AAEM,IAAM,aAAa,CACxB,YACG,cACA;AACH,aAAO,aAAAA,YAAe,SAAS,SAAS,GAAG,SAAS;AACtD;","names":["import_core","import_core","coreCreateLyla"]}